name: Release

on:
  schedule:
    - cron: "0 0 * * 1"  # Runs every Monday at midnight UTC
  push:
    branches:
      - arm64
  workflow_dispatch:  # Allows manual triggering

jobs:
  Kitty:
    runs-on: ubuntu-22.04  # Using ARM64-compatible Ubuntu 22.04 runner

    strategy:
      matrix:
        version: ['3.8']

    steps:
      - uses: actions/checkout@v2

      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar libfuse2  # Install wget, tar, and libfuse2 for AppImage support
          sudo apt-get install -y qemu-user-static  # Install QEMU for ARM64 emulation

      - name: Set up Docker for ARM64 emulation
        run: |
          docker buildx create --use  # Enable multi-architecture build support

      - name: Build Kitty AppImage
        run: |
          # Pull the pre-built appimagetool for ARM64 if you don't have a custom Dockerfile
          docker run --rm -v $(pwd):/mnt  ghcr.io/AppImage/AppImageKit/appimagetool:latest /mnt/AppDir -n -u gh-releases-zsync|lucasscvvieira|kitty-appimage|stable|Kitty*.AppImage.zsync Kitty--arm64.AppImage

      - name: Release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          title: Kitty Stable AppImage Builds
          automatic_release_tag: stable
          prerelease: false
          draft: false
          files: ./kitty/dist/Kitty-*-arm64.AppImage*  # Change architecture from x86_64 to arm64
          repo_token: ${{ secrets.GITHUB_TOKEN }}
